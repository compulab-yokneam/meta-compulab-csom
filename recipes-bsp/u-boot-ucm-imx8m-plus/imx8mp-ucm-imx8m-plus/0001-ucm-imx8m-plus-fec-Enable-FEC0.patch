From f795146d6493759d562dce878e2ada9d3a764f49 Mon Sep 17 00:00:00 2001
From: Valentin Raevsky <valentin@compulab.co.il>
Date: Wed, 11 May 2022 18:34:57 +0300
Subject: [PATCH] ucm-imx8m-plus: fec: Enable FEC0

Signed-off-by: Valentin Raevsky <valentin@compulab.co.il>
---
 arch/arm/dts/ucm-imx8m-plus-fec.dtsi          | 45 +++++++++++++++++++
 arch/arm/dts/ucm-imx8m-plus.dts               |  2 +
 .../compulab/ucm-imx8m-plus/ucm-imx8m-plus.c  | 22 ++++++++-
 3 files changed, 68 insertions(+), 1 deletion(-)
 create mode 100644 arch/arm/dts/ucm-imx8m-plus-fec.dtsi

diff --git a/arch/arm/dts/ucm-imx8m-plus-fec.dtsi b/arch/arm/dts/ucm-imx8m-plus-fec.dtsi
new file mode 100644
index 0000000000..7fbd3e3e67
--- /dev/null
+++ b/arch/arm/dts/ucm-imx8m-plus-fec.dtsi
@@ -0,0 +1,45 @@
+&iomuxc {
+	pinctrl_fec: fecgrp {
+		fsl,pins = <
+			MX8MP_IOMUXC_SD1_CLK__ENET1_MDC			0x3
+			MX8MP_IOMUXC_SD1_CMD__ENET1_MDIO		0x3
+			MX8MP_IOMUXC_SD1_DATA2__ENET1_RGMII_RD0		0x91
+			MX8MP_IOMUXC_SD1_DATA3__ENET1_RGMII_RD1		0x91
+			MX8MP_IOMUXC_SAI1_RXD6__ENET1_RGMII_RD2		0x91
+			MX8MP_IOMUXC_SAI1_RXD7__ENET1_RGMII_RD3		0x91
+			MX8MP_IOMUXC_SAI1_TXC__ENET1_RGMII_RXC		0x91
+			MX8MP_IOMUXC_SAI1_TXFS__ENET1_RGMII_RX_CTL	0x91
+			MX8MP_IOMUXC_SD1_DATA1__ENET1_RGMII_TD0		0x1f
+			MX8MP_IOMUXC_SD1_DATA0__ENET1_RGMII_TD1		0x1f
+			MX8MP_IOMUXC_SAI1_TXD2__ENET1_RGMII_TD2		0x1f
+			MX8MP_IOMUXC_SAI1_TXD3__ENET1_RGMII_TD3		0x1f
+			MX8MP_IOMUXC_SAI1_TXD4__ENET1_RGMII_TX_CTL	0x1f
+			MX8MP_IOMUXC_SAI1_TXD5__ENET1_RGMII_TXC		0x1f
+			MX8MP_IOMUXC_SPDIF_EXT_CLK__GPIO5_IO05		0x19
+		>;
+	};
+};
+
+&fec {
+	pinctrl-names = "default";
+	pinctrl-0 = <&pinctrl_fec>;
+	phy-mode = "rgmii-id";
+	phy-handle = <&ethphy1>;
+	fsl,magic-packet;
+	phy-reset-gpios = <&gpio5 5 GPIO_ACTIVE_LOW>;
+	phy-reset-duration = <10>;
+	phy-reset-post-delay = <150>;
+	status = "okay";
+
+	mdio {
+		compatible = "snps,dwmac-mdio";
+		#address-cells = <1>;
+		#size-cells = <0>;
+
+		ethphy1: ethernet-phy@1 {
+			compatible = "ethernet-phy-ieee802.3-c22";
+			reg = <1>;
+			eee-broken-1000t;
+		};
+	};
+};
diff --git a/arch/arm/dts/ucm-imx8m-plus.dts b/arch/arm/dts/ucm-imx8m-plus.dts
index a1111161c9..ebce0f3a41 100644
--- a/arch/arm/dts/ucm-imx8m-plus.dts
+++ b/arch/arm/dts/ucm-imx8m-plus.dts
@@ -651,3 +651,5 @@
 &soc_crit0 {
     temperature = <155000>;
 };
+
+#include "ucm-imx8m-plus-fec.dtsi"
diff --git a/board/compulab/ucm-imx8m-plus/ucm-imx8m-plus.c b/board/compulab/ucm-imx8m-plus/ucm-imx8m-plus.c
index 3b3ec6a912..8a73582ad9 100644
--- a/board/compulab/ucm-imx8m-plus/ucm-imx8m-plus.c
+++ b/board/compulab/ucm-imx8m-plus/ucm-imx8m-plus.c
@@ -29,13 +29,33 @@
 
 DECLARE_GLOBAL_DATA_PTR;
 
+#ifdef CONFIG_FEC_MXC
+static int setup_fec(void)
+{
+	struct iomuxc_gpr_base_regs *gpr =
+		(struct iomuxc_gpr_base_regs *)IOMUXC_GPR_BASE_ADDR;
+
+	/* Enable RGMII TX clk output */
+	setbits_le32(&gpr->gpr[1], BIT(22) | BIT(13));
+
+	return set_clk_enet(ENET_125MHZ);
+}
+#endif
+
 #if defined(CONFIG_FEC_MXC) || defined(CONFIG_DWC_ETH_QOS)
 #include "../common/eeprom.h"
 void imx_get_mac_from_fuse(int dev_id, unsigned char *mac)
 {
-	cl_eeprom_read_n_mac_addr(mac, /*dev_id*/ 0, CONFIG_SYS_I2C_EEPROM_BUS);
+	cl_eeprom_read_n_mac_addr(mac, dev_id, CONFIG_SYS_I2C_EEPROM_BUS);
 	debug("%s: MAC%d: %02x.%02x.%02x.%02x.%02x.%02x\n",
 	      __func__, dev_id, mac[0], mac[1], mac[2], mac[3], mac[4], mac[5]);
 	return;
 }
 #endif
+
+void board_vendor_init(void) {
+#ifdef CONFIG_FEC_MXC
+	setup_fec();
+#endif
+	return;
+}
-- 
2.17.1

